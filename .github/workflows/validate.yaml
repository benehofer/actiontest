#<DOC>
#The validate pipeline is executed for pull requests on the main branch. The pipeline is only executed 
#when changes are made to the iac code artefacts and performs the build and plan steps for the artefacts. 
#Before a pull request can be merged, you must wait for this pipeline to run. The pipeline log shows the 
#effects of the iac adjustments.
#</DOC>
name: 'Production validation'

on:
  pull_request:
    branches:
      - main
    paths:
      - 'iac/**'

jobs:
  detect-change:
    uses: ./.github/workflows/template-detect-change.yaml

  build-iac:
    needs: detect-change
    if: ${{ needs.detect-change.outputs.iac == 'true'}}
    uses: ./.github/workflows/template-build.yaml
    with:
      doenv: "${{ github.ref == 'refs/heads/main' && 'Production' || 'Integration' }}-plan"
      artifacttype: 'iac'

  plan-iac:
    needs: build-iac
    permissions:
      contents: 'read'
      id-token: 'write'
    uses: ./.github/workflows/template-deploy.yaml
    with:
      doenv: "${{ github.ref == 'refs/heads/main' && 'Production' || 'Integration' }}-plan"
      workflowtype: iac
      mode: plan
    secrets: inherit      
  